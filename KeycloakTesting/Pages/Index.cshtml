@page
@model KeycloakTesting.Pages.IndexModel
@{
    ViewData["Title"] = "User Data Management";
}

<h1>@ViewData["Title"]</h1>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))

{
    <div class="alert alert-danger">
        @Model.ErrorMessage
    </div>
}

<!-- Button to Open the Modal -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createUserModal">
    Create New User
</button>

<h2>Existing User Data</h2>
<table class="table table-striped" id="userDataTable">
    <thead>
        <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Phone Number</th>
            <th>Address</th>
            <th>Actions</th>
            <!-- Add additional headers as needed -->
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Model.UserDataList)

        {
            <tr>
                <td>@user.FullName</td>
                <td>@user.UserEmail</td>
                <td>@user.PhoneNum</td>
                <td>@user.Address</td>
                <td>
                    <button class="btn btn-danger btn-sm delete-button" data-index="@((Model.UserDataList.IndexOf(user)))">Delete</button>
                </td>
                <!-- Add additional columns as needed -->
            </tr>
        }
    </tbody>
</table>

<!-- Modal Popup for Creating New User -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <!-- Modal Title -->
                <h5 class="modal-title" id="createUserModalLabel">Create New User Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Form Inside Modal -->
                <form id="createForm">
                    <div class="mb-3">
                        <label for="FullName" class="form-label">Full Name</label>
                        <input type="text" id="FullName" name="FullName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="UserEmail" class="form-label">Email Address</label>
                        <input type="email" id="UserEmail" name="UserEmail" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="PhoneNum" class="form-label">Phone Number</label>
                        <input type="tel" id="PhoneNum" name="PhoneNum" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="Address" class="form-label">Address</label>
                        <input type="text" id="Address" name="Address" class="form-control" required />
                    </div>
                    <!-- Add additional fields as needed -->
                </form>
            </div>
            <div class="modal-footer">
                <!-- Modal Footer Buttons -->
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="submitCreateForm" class="btn btn-success">Create</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- JavaScript Code -->
    <script>
        $(document).ready(function () {
            // Show spinner on AJAX start, hide on AJAX complete
            $(document).ajaxStart(function () {
                $('#loadingSpinner').show();
            }).ajaxStop(function () {
                $('#loadingSpinner').hide();
            });

            // Function to load user data and populate the table
            function loadUserData() {
                $.ajax({
                    url: '/api/UserData',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var tbody = $('#userDataTable tbody');
                        tbody.empty(); // Clear existing data

                        data.forEach(function (user, index) {
                            var row = '<tr>' +
                                '<td>' + user.fullName + '</td>' +
                                '<td>' + user.userEmail + '</td>' +
                                '<td>' + user.phoneNum + '</td>' +
                                '<td>' + user.address + '</td>' +
                                '<td>' +
                                '<button class="btn btn-danger btn-sm delete-button" data-index="' + index + '">Delete</button>' +
                                '</td>' +
                                '</tr>';
                            tbody.append(row);
                        });
                    },
                    error: function (xhr, status, error) {
                        alert('Failed to load user data: ' + error);
                    }
                });
            }

            // Initial load of user data
            loadUserData();

            // Handle form submission inside the modal
            $('#submitCreateForm').click(function () {
                var formData = {
                    FullName: $('#FullName').val(),
                    UserEmail: $('#UserEmail').val(),
                    PhoneNum: $('#PhoneNum').val(),
                    Address: $('#Address').val()
                    // Include additional fields as needed
                };

                $.ajax({
                    url: '/api/UserData',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (data, status, xhr) {
                        alert('User data created successfully!');
                        // Refresh the table
                        loadUserData();
                        // Reset the form
                        $('#createForm')[0].reset();
                        // Close the modal
                        $('#createUserModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        var errorMessage = 'Error: ' + (xhr.responseJSON?.message || error);
                        alert(errorMessage);
                    }
                });
            });

            // Handle delete button clicks
            $('#userDataTable').on('click', '.delete-button', function () {
                var index = $(this).data('index');

                if (confirm('Are you sure you want to delete this record?')) {
                    $.ajax({
                        url: '/api/UserData/' + index,
                        type: 'DELETE',
                        success: function () {
                            alert('User data deleted successfully!');
                            loadUserData();
                        },
                        error: function (xhr, status, error) {
                            alert('Error deleting user data: ' + error);
                        }
                    });
                }
            });
        });
    </script>
}
